<!-- å¤‡ä»½ç®¡ç† Tab -->
<div class="tab-panel space-y-4" data-tab="backup">
  <div class="flex flex-wrap gap-2 mb-2">
    <button onclick="createBackup(this)" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ’¾ æ‰‹åŠ¨å¤‡ä»½</button>
    <button onclick="loadBackups()" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ”„ åˆ·æ–°</button>
  </div>

  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr>
            <th class="py-3 px-4">æ–‡ä»¶å</th>
            <th class="py-3 px-4">å¤§å°</th>
            <th class="py-3 px-4">æ—¶é—´</th>
            <th class="py-3 px-4">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="text-gray-300" id="backup-list"></tbody>
      </table>
    </div>
  </div>
</div>

<script nonce="<%= nonce %>">
function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(2) + ' MB';
}

async function loadBackups() {
  try {
    const r = await fetch('/admin/api/backups', { headers: { 'X-CSRF-Token': _csrf } });
    const d = await r.json();
    const tbody = document.getElementById('backup-list');
    if (!d.ok || !d.backups.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="py-6 text-center text-gray-500">æš‚æ— å¤‡ä»½æ–‡ä»¶</td></tr>';
      return;
    }
    tbody.innerHTML = d.backups.map(b => `
      <tr class="border-b border-white/5 hover:bg-white/[0.02]">
        <td class="py-3 px-4 text-xs font-mono">${b.name}</td>
        <td class="py-3 px-4 text-xs">${fmtSize(b.size)}</td>
        <td class="py-3 px-4 text-xs">${new Date(b.mtime).toLocaleString('zh-CN')}</td>
        <td class="py-3 px-4 space-x-2">
          <a href="/admin/api/backups/download/${b.name}" class="text-cyan-400 hover:text-cyan-300 text-xs">ä¸‹è½½</a>
          <button onclick="restoreBackup('${b.name}')" class="text-amber-400 hover:text-amber-300 text-xs">æ¢å¤</button>
        </td>
      </tr>
    `).join('');
  } catch(e) { toast('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥', 2500, 'error'); }
}

async function createBackup(btn) {
  const orig = btn.textContent;
  btn.textContent = 'â³ å¤‡ä»½ä¸­...'; btn.disabled = true;
  try {
    const r = await fetch('/admin/api/backups/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf }
    });
    const d = await r.json();
    if (d.ok) { toast('âœ… å¤‡ä»½æˆåŠŸ'); loadBackups(); }
    else toast('âŒ ' + (d.error || 'å¤‡ä»½å¤±è´¥'), 2500, 'error');
  } catch(e) { toast('âŒ ç½‘ç»œé”™è¯¯', 2500, 'error'); }
  btn.textContent = orig; btn.disabled = false;
}

async function restoreBackup(name) {
  const ok = await _confirm('âš ï¸ ç¡®å®šä»å¤‡ä»½æ¢å¤ï¼Ÿå½“å‰æ•°æ®åº“å°†è¢«è¦†ç›–ï¼ˆä¼šå…ˆè‡ªåŠ¨å¤‡ä»½ï¼‰');
  if (!ok) return;
  try {
    const r = await fetch('/admin/api/backups/restore', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({ name })
    });
    const d = await r.json();
    if (d.ok) toast('âœ… æ¢å¤æˆåŠŸï¼Œå»ºè®®é‡å¯é¢æ¿');
    else toast('âŒ ' + (d.error || 'æ¢å¤å¤±è´¥'), 2500, 'error');
  } catch(e) { toast('âŒ ç½‘ç»œé”™è¯¯', 2500, 'error'); }
}
</script>
