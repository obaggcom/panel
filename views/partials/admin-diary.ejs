<!-- AI è¿è¥æ—¥è®° Tab -->
<div class="tab-panel space-y-4" data-tab="diary">
  <!-- å¤´éƒ¨ç»Ÿè®¡ -->
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-white text-sm font-medium">ğŸ“” AI è¿è¥æ—¥è®°</h3>
        <p class="text-gray-500 text-xs mt-1">å°ä¹–æ¯æ¬¡åšçš„äº‹æƒ…éƒ½ä¼šè®°å½•åœ¨è¿™é‡Œï¼Œè§è¯é¢æ¿çš„æˆé•¿ ğŸŒ±</p>
      </div>
      <div class="text-right">
        <div class="text-2xl font-bold text-white" id="diary-total">-</div>
        <div class="text-[11px] text-gray-500">ç¯‡æ—¥è®°</div>
      </div>
    </div>
    <div class="flex gap-4 mt-3 text-xs text-gray-500">
      <span>ğŸ“ ä»Šæ—¥ <span class="text-white" id="diary-today">-</span> ç¯‡</span>
      <span>ğŸ“… é¦–ç¯‡ <span class="text-gray-300" id="diary-first">-</span></span>
    </div>
  </div>

  <!-- æ—¶é—´çº¿ -->
  <div class="glass rounded-2xl p-5">
    <div id="diary-timeline" class="space-y-0">
      <p class="text-gray-600 text-xs text-center py-8">åŠ è½½ä¸­...</p>
    </div>
    <div class="flex items-center justify-between mt-4 pt-3 border-t border-white/5">
      <span class="text-gray-600 text-xs" id="diary-page-info"></span>
      <div class="flex gap-1" id="diary-pager"></div>
    </div>
  </div>
</div>

<script nonce="<%= nonce %>">
async function loadDiary(page = 1) {
  try {
    const res = await fetch('/admin/api/diary?page=' + page);
    const d = await res.json();

    // ç»Ÿè®¡
    if (d.stats) {
      document.getElementById('diary-total').textContent = d.stats.total;
      document.getElementById('diary-today').textContent = d.stats.todayCount;
      document.getElementById('diary-first').textContent = d.stats.firstEntryDisplay
        ? d.stats.firstEntryDisplay.slice(0, 10) : 'è¿˜æ²¡æœ‰å‘¢';
    }

    // æ—¶é—´çº¿
    const timeline = document.getElementById('diary-timeline');
    if (!d.rows || d.rows.length === 0) {
      timeline.innerHTML = `<div class="text-center py-12">
        <div class="text-4xl mb-3">ğŸ“”</div>
        <p class="text-gray-500 text-sm">è¿˜æ²¡æœ‰æ—¥è®°å‘¢</p>
        <p class="text-gray-600 text-xs mt-1">å°ä¹–å¼€å§‹è¿ç»´åä¼šè‡ªåŠ¨è®°å½•ï½</p>
      </div>`;
    } else {
      let lastDate = '';
      let html = '';
      for (const entry of d.rows) {
        const date = entry.created_date_display || '';
        const time = entry.created_time_display || '';

        // æ—¥æœŸåˆ†éš”
        if (date !== lastDate) {
          lastDate = date;
          const weekday = (entry.created_weekday_display || '').replace(/^å‘¨/, '');
          html += `<div class="flex items-center gap-3 py-3 ${html ? 'mt-2' : ''}">
            <div class="h-px flex-1 bg-white/5"></div>
            <span class="text-xs text-gray-400 font-medium">ğŸ“… ${date} æ˜ŸæœŸ${weekday}</span>
            <div class="h-px flex-1 bg-white/5"></div>
          </div>`;
        }

        // åˆ†ç±»é¢œè‰²
        const catColors = {
          'ops': 'border-blue-500/30',
          'repair': 'border-amber-500/30',
          'swap_ip': 'border-rose-500/30',
          'deploy': 'border-emerald-500/30',
          'scale': 'border-purple-500/30',
          'patrol': 'border-cyan-500/30',
          'milestone': 'border-yellow-500/30',
        };
        const borderColor = catColors[entry.category] || 'border-white/10';

        html += `<div class="flex gap-3 py-2 group">
          <div class="flex flex-col items-center flex-shrink-0">
            <span class="text-lg">${entry.mood}</span>
            <div class="w-px flex-1 bg-white/5 mt-1 group-last:hidden"></div>
          </div>
          <div class="flex-1 pb-2">
            <div class="rounded-xl bg-black/20 border-l-2 ${borderColor} px-3 py-2.5">
              <div class="text-xs text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(entry.content)}</div>
              <div class="flex items-center gap-2 mt-1.5">
                <span class="text-[10px] text-gray-600">${time}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-white/5 text-gray-500">${entry.category}</span>
              </div>
            </div>
          </div>
        </div>`;
      }
      timeline.innerHTML = html;
    }

    // åˆ†é¡µ
    document.getElementById('diary-page-info').textContent =
      d.total > 0 ? `ç¬¬ ${(page-1)*20+1}-${Math.min(page*20, d.total)} æ¡ï¼Œå…± ${d.total} æ¡` : '';
    const pager = document.getElementById('diary-pager');
    pager.innerHTML = '';
    if (d.pages > 1) {
      for (let i = 1; i <= Math.min(d.pages, 10); i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'text-xs px-2 py-1 rounded ' + (i === page ? 'bg-rose-600 text-white' : 'glass text-gray-400 hover:text-white');
        btn.onclick = () => loadDiary(i);
        pager.appendChild(btn);
      }
    }
  } catch (e) {
    document.getElementById('diary-timeline').innerHTML =
      '<p class="text-red-400 text-xs text-center py-4">åŠ è½½å¤±è´¥</p>';
  }
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

if (location.hash === '#diary') setTimeout(() => loadDiary(1), 100);
</script>
