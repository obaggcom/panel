<%- include('partials/head', { title: 'èŠ‚ç‚¹é¢æ¿' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­çš„è¯±æƒ‘</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-gray-300 text-sm hidden sm:block"><%= user.name || user.username %></span>
        <% if (user.is_admin) { %><a href="/admin" class="text-xs px-3 py-1.5 rounded-full bg-amber-500/20 text-amber-300 hover:bg-amber-500/30 transition">ç®¡ç†</a><% } %>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">é€€å‡º</a>
      </div>
    </div>
  </nav>

  <% if (announcement) { %>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 mt-4">
    <div class="bg-rose-500/10 border border-rose-500/20 rounded-2xl">
      <div class="px-4 py-2 flex items-center gap-2 text-xs">
        <span class="text-rose-400 shrink-0">ğŸ“¢</span>
        <div class="marquee-wrap">
          <span class="animate-marquee text-rose-200/80"><%= announcement %></span>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- æµé‡æ¦‚è§ˆ -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#f43f5e">
        <p class="text-gray-500 text-xs mb-1">èŠ‚ç‚¹åœ¨çº¿ç”¨æˆ·</p>
        <p class="text-rose-400 text-lg font-bold" id="online-count">-</p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#8b5cf6">
        <p class="text-gray-500 text-xs mb-1">å…¨ç«™å·²ç”¨</p>
        <p class="text-violet-400 text-lg font-bold"><%= formatBytes(globalTraffic.total_up + globalTraffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#fb923c">
        <p class="text-gray-500 text-xs mb-1">å·²ç”¨æµé‡</p>
        <p class="text-orange-400 text-lg font-bold"><%= formatBytes(traffic.total_up + traffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#06b6d4">
        <p class="text-gray-500 text-xs mb-1">å‰©ä½™æµé‡</p>
        <p class="text-cyan-400 text-lg font-bold"><%= trafficLimit > 0 ? formatBytes(Math.max(0, trafficLimit - traffic.total_up - traffic.total_down)) : 'âˆ' %></p>
      </div>
      <% if (expiresAt) { %>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#a78bfa">
        <p class="text-gray-500 text-xs mb-1">è´¦å·åˆ°æœŸ</p>
        <% const _daysLeft = Math.ceil((new Date(expiresAt).getTime() - Date.now()) / 86400000); %>
        <p class="<%= _daysLeft <= 3 ? 'text-red-400' : 'text-violet-400' %> text-lg font-bold"><%= _daysLeft > 0 ? _daysLeft + ' å¤©' : 'å·²è¿‡æœŸ' %></p>
      </div>
      <% } %>
    </div>

    <!-- è®¢é˜…é“¾æ¥ -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-1.5">
        <h2 class="text-white font-semibold text-sm">ğŸ“¡ ä¸ªäººè®¢é˜…</h2>
        <div class="text-[11px] text-gray-300 text-right">
          <div>UUID ä¸‹æ¬¡é‡ç½®ï¼š<span id="uuid-reset-countdown" class="text-rose-300">è®¡ç®—ä¸­...</span></div>
          <div>è®¢é˜…é“¾æ¥ä¸‹æ¬¡é‡ç½®ï¼š<span id="sub-reset-countdown" class="text-cyan-300">è®¡ç®—ä¸­...</span></div>
        </div>
      </div>
      <div class="flex gap-2">
        <input type="text" readonly value="<%= subUrl %>" id="sub-link"
               class="flex-1 bg-black/30 text-rose-300 text-xs px-4 py-2.5 rounded-xl border border-white/5 font-mono">
        <button onclick="copySubLink()" class="bg-rose-600 hover:bg-rose-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">å¤åˆ¶</button>
        <button onclick="showSubQr()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">äºŒç»´ç </button>
      </div>
    </div>

    <!-- è®¢é˜…äºŒç»´ç å¼¹çª— -->
    <div id="sub-qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm" onclick="if(event.target===this)hideSubQr()">
      <div class="glass-solid rounded-2xl p-5 w-[92%] max-w-sm border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-white font-semibold text-sm">ğŸ“± æ‰«ç æ·»åŠ è®¢é˜…</h3>
          <button onclick="hideSubQr()" class="text-gray-400 hover:text-white text-lg leading-none">âœ•</button>
        </div>
        <p class="text-gray-400 text-xs mb-3">ç”¨æ‰‹æœºå®¢æˆ·ç«¯æ‰«ç å³å¯å¯¼å…¥å½“å‰è´¦å·è®¢é˜…é“¾æ¥</p>
        <div class="bg-white rounded-xl p-3 mx-auto w-fit mb-3">
          <img id="sub-qr-img" alt="è®¢é˜…äºŒç»´ç " class="w-[220px] h-[220px] block" />
        </div>
        <p class="text-[11px] text-gray-500 break-all font-mono select-all" id="sub-qr-text"></p>
      </div>
    </div>

    <!-- èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç»„å±•ç¤ºï¼‰ -->
    <div>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-white font-semibold">ğŸŒ å¯ç”¨èŠ‚ç‚¹</h2>
        <div class="flex items-center gap-2">
          <button onclick="testLatency(this)" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">âš¡ å»¶è¿Ÿæµ‹è¯•</button>
          <span class="text-gray-600 text-xs"><%= userNodes.length %> ä¸ªèŠ‚ç‚¹</span>
        </div>
      </div>
      <%
        // æŒ‰ group_name åˆ†ç»„
        const _groups = {};
        userNodes.forEach(n => {
          const g = n.group_name || 'é»˜è®¤';
          if (!_groups[g]) _groups[g] = [];
          _groups[g].push(n);
        });
        const _groupNames = Object.keys(_groups).sort((a, b) => a === 'é»˜è®¤' ? 1 : b === 'é»˜è®¤' ? -1 : a.localeCompare(b));
      %>
      <% _groupNames.forEach(gName => { %>
        <% if (_groupNames.length > 1) { %>
        <h3 class="text-gray-400 text-sm font-medium mb-2 mt-4 flex items-center gap-1.5">
          <span class="w-1 h-4 rounded-full bg-rose-500/50"></span> <%= gName %>
          <span class="text-gray-600 text-xs">(<%= _groups[gName].length %>)</span>
        </h3>
        <% } %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 node-card-grid mb-3">
        <% if (userNodes.length === 0 && gName === _groupNames[0]) { %>
          <div class="glass rounded-2xl p-8 col-span-full text-center">
            <p class="text-gray-500">æš‚æ— å¯ç”¨èŠ‚ç‚¹</p>
          </div>
        <% } else { _groups[gName].forEach(function(n) { %>
          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-white font-medium text-sm"><%= n.name %></h3>
              <div class="flex items-center gap-1.5">
                <span class="text-gray-600 text-[10px] latency-badge" id="latency-<%= n.id %>"></span>
                <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="è¢«å¢™"></span>
                <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="ç¦»çº¿"></span>
                <% } else if (n.is_active) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="åœ¨çº¿"></span>
                <% } else { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]" title="æ£€æµ‹ä¸­"></span>
                <% } %>
              </div>
            </div>
            <% if (n.region) { %><p class="text-gray-500 text-xs mb-3"><%= n.region %><% if (n.tags) { %> Â· <span class="text-gray-600"><%= n.tags %></span><% } %></p><% } %>
            <div class="bg-black/30 rounded-lg p-2.5 mb-2.5 overflow-hidden">
              <code class="text-rose-300 text-[11px] break-all select-all font-mono vless-link leading-relaxed block max-h-20 overflow-y-auto" id="link-<%= n.id %>"><%= n.link %></code>
            </div>
            <button onclick="copyLink(<%= n.id %>)" class="w-full bg-rose-600/80 hover:bg-rose-500 text-white text-xs py-2 rounded-lg transition">å¤åˆ¶é“¾æ¥</button>
          </div>
        <% }); } %>
      </div>
      <% }); %>
    </div>

    <!-- æµé‡ä½¿ç”¨æ˜ç»† -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-white font-semibold text-sm">ğŸ“Š æµé‡ä½¿ç”¨æ˜ç»†</h2>
        <select id="traffic-days" onchange="loadTrafficDetail()" class="bg-black/30 text-white text-xs px-3 py-1.5 rounded-lg border border-white/10">
          <option value="7">æœ€è¿‘ 7 å¤©</option>
          <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
          <option value="90">æœ€è¿‘ 90 å¤©</option>
        </select>
      </div>
      <canvas id="traffic-chart" height="160" class="mb-4"></canvas>
      <div class="overflow-x-auto">
        <table class="w-full text-xs text-left" id="traffic-detail-table">
          <thead class="text-gray-500 border-b border-white/5">
            <tr><th class="py-2 px-3">æ—¥æœŸ</th><th class="py-2 px-3">èŠ‚ç‚¹</th><th class="py-2 px-3">ä¸Šä¼ </th><th class="py-2 px-3">ä¸‹è½½</th><th class="py-2 px-3">åˆè®¡</th></tr>
          </thead>
          <tbody class="text-gray-300" id="traffic-detail-body"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    function copyLink(id) {
      navigator.clipboard.writeText(document.getElementById('link-' + id).textContent).then(() => toast('âœ… é“¾æ¥å·²å¤åˆ¶'));
    }
    function copySubLink() {
      navigator.clipboard.writeText(document.getElementById('sub-link').value).then(() => toast('âœ… è®¢é˜…é“¾æ¥å·²å¤åˆ¶'));
    }
    function showSubQr() {
      const link = document.getElementById('sub-link').value;
      const modal = document.getElementById('sub-qr-modal');
      const img = document.getElementById('sub-qr-img');
      document.getElementById('sub-qr-text').textContent = link;
      img.src = '/sub-qr?t=' + Date.now();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideSubQr() {
      const modal = document.getElementById('sub-qr-modal');
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }

    // åŠ è½½åœ¨çº¿äººæ•°
    fetch('/online-count').then(r=>r.json()).then(d=>{
      const el = document.getElementById('online-count');
      if (el) el.textContent = d.online + ' äºº';
    }).catch(()=>{});

    // è®¢é˜…é‡ç½®å€’è®¡æ—¶
    const nextUuidResetAt = <%- JSON.stringify(nextUuidResetAt || 0) %>;
    const nextSubResetAt = <%- JSON.stringify(nextSubResetAt || 0) %>;

    function fmtCountdown(ms) {
      if (ms <= 0) return 'å³å°†é‡ç½®';
      const s = Math.floor(ms / 1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (d > 0) return `${d}å¤© ${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      if (h > 0) return `${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      return `${m}åˆ†é’Ÿ`;
    }

    function tickResetCountdown() {
      const now = Date.now();
      const u = document.getElementById('uuid-reset-countdown');
      const t = document.getElementById('sub-reset-countdown');
      if (u) u.textContent = fmtCountdown(nextUuidResetAt - now);
      if (t) t.textContent = fmtCountdown(nextSubResetAt - now);
    }
    tickResetCountdown();
    setInterval(tickResetCountdown, 30000);

    // Sprint 6: å»¶è¿Ÿæµ‹è¯•
    async function testLatency(btn) {
      const orig = btn.textContent;
      btn.textContent = 'â³ æµ‹è¯•ä¸­...';
      btn.disabled = true;
      try {
        const r = await fetch('/api/ping-nodes');
        const d = await r.json();
        if (d.ok) {
          d.results.forEach(n => {
            const el = document.getElementById('latency-' + n.id);
            if (el) {
              if (n.latency >= 0) {
                const color = n.latency < 100 ? 'text-emerald-400' : n.latency < 300 ? 'text-yellow-400' : 'text-red-400';
                el.className = `text-[10px] latency-badge ${color}`;
                el.textContent = n.latency + 'ms';
              } else {
                el.className = 'text-[10px] latency-badge text-red-400';
                el.textContent = 'è¶…æ—¶';
              }
            }
          });
          toast('âœ… å»¶è¿Ÿæµ‹è¯•å®Œæˆ');
        }
      } catch(e) { toast('âŒ æµ‹è¯•å¤±è´¥'); }
      btn.textContent = orig;
      btn.disabled = false;
    }

    // Sprint 6: æµé‡æ˜ç»†
    function fmtB(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
      if (b < 1073741824) return (b/1048576).toFixed(2) + ' MB';
      return (b/1073741824).toFixed(2) + ' GB';
    }

    let _chart = null;
    async function loadTrafficDetail() {
      const days = document.getElementById('traffic-days').value;
      try {
        const r = await fetch('/api/traffic-detail?days=' + days);
        const d = await r.json();
        if (!d.ok) return;
        // è¡¨æ ¼
        const tbody = document.getElementById('traffic-detail-body');
        tbody.innerHTML = d.detail.slice(0, 100).map(r =>
          `<tr class="border-b border-white/5"><td class="py-1.5 px-3">${r.date}</td><td class="py-1.5 px-3">${r.node_name||'å·²åˆ é™¤'}</td><td class="py-1.5 px-3">${fmtB(r.uplink)}</td><td class="py-1.5 px-3">${fmtB(r.downlink)}</td><td class="py-1.5 px-3">${fmtB(r.uplink+r.downlink)}</td></tr>`
        ).join('') || '<tr><td colspan="5" class="py-4 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
        // å›¾è¡¨
        const canvas = document.getElementById('traffic-chart');
        const ctx = canvas.getContext('2d');
        if (_chart) { _chart = null; }
        const trend = d.trend;
        if (trend.length === 0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
        drawChart(ctx, canvas, trend);
      } catch(e) {}
    }

    function drawChart(ctx, canvas, trend) {
      const W = canvas.width = canvas.offsetWidth * 2;
      const H = canvas.height = 320;
      ctx.clearRect(0,0,W,H);
      const pad = {t:20,r:20,b:40,l:60};
      const cw = W-pad.l-pad.r, ch = H-pad.t-pad.b;
      const maxVal = Math.max(...trend.map(t=>t.total_up+t.total_down), 1);
      // ç½‘æ ¼
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      for (let i=0;i<=4;i++) {
        const y = pad.t + ch*(1-i/4);
        ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
        ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='18px sans-serif'; ctx.textAlign='right';
        ctx.fillText(fmtB(maxVal*i/4), pad.l-8, y+5);
      }
      // æŸ±çŠ¶å›¾
      const bw = Math.max(2, cw/trend.length - 2);
      trend.forEach((t,i) => {
        const x = pad.l + (i+0.5)*cw/trend.length - bw/2;
        const val = t.total_up+t.total_down;
        const h = (val/maxVal)*ch;
        const grad = ctx.createLinearGradient(0,pad.t+ch-h,0,pad.t+ch);
        grad.addColorStop(0,'rgba(244,63,94,0.8)'); grad.addColorStop(1,'rgba(251,146,60,0.3)');
        ctx.fillStyle=grad;
        ctx.fillRect(x, pad.t+ch-h, bw, h);
        if (trend.length <= 14) {
          ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='16px sans-serif'; ctx.textAlign='center';
          ctx.save(); ctx.translate(x+bw/2, H-5); ctx.rotate(-0.5); ctx.fillText(t.date.slice(5),0,0); ctx.restore();
        }
      });
    }

    loadTrafficDetail();
  </script>
<%- include('partials/foot') %>
